<%- partial('_partials/plugins/nprogress.ejs') %>
<%- js_ex(theme.static_prefix.internal_js, 'bootstrap-lite.js', 'defer') %>
<%- js_ex(theme.static_prefix.internal_js, 'events.js', 'defer') %>
<%- js_ex(theme.static_prefix.internal_js, 'plugins.js', 'defer') %>

<%- partial('_partials/plugins/typed.ejs') %>

<% if (theme.lazyload.enable){ %>
  <% if (theme.lazyload.onlypost) { %>
    <% if (is_post() || is_page()) { %>
      <%- js_ex(theme.static_prefix.internal_js, 'img-lazyload.js', 'defer') %>
    <% } %>
  <% } else { %>
    <%- js_ex(theme.static_prefix.internal_js, 'img-lazyload.js', 'defer') %>
  <% } %>
<% } %>

<% var script_snippets = deduplicate(page.script_snippets) %>
<% for (var idx = 0; idx < script_snippets.length; idx++) { %>
  <%- script_snippets[idx] %>
<% } %>
<% page.script_snippets = [] %>

<% if (theme.custom_js) { %>
  <% var customJS = Array.isArray(theme.custom_js) ? theme.custom_js : [theme.custom_js] %>
  <% for (var jsPath of customJS) { %>
    <script defer src="<%= url_for(jsPath) %>"></script>
  <% } %>
<% } %>

<% 
  var danmakuEnabled = theme.danmaku && (theme.danmaku.enabled === true || theme.danmaku.enable === true);
  var danmakuPage = (theme.danmaku && theme.danmaku.page ? theme.danmaku.page : '/comments/').replace(/^\//, '');
  var currentPath = (page.path || '').replace(/index\.html$/, '');
  var shouldLoadDanmaku = danmakuEnabled && currentPath === danmakuPage;
%>
<% if (shouldLoadDanmaku) { %>
  <!-- 注入 danmakuConfig 配置到页面中（仅弹幕页加载） -->
  <script>
    // 使用 window 挂载，确保其他脚本可访问
    window.danmakuConfig = {
      page: '<%= theme.danmaku.page %>' || '/comments/',
      line: Number('<%- theme.danmaku.line %>') || 10,
      speed: Number('<%- theme.danmaku.speed %>') || 20,
      hover: '<%= theme.danmaku.hover ? "true" : "false" %>' === 'true',
      loop: '<%= theme.danmaku.loop ? "true" : "false" %>' === 'true'
    };
  </script>
  <%- js_ex(theme.static_prefix.internal_js, 'comment.js', 'defer') %>
  <%- js_ex(theme.static_prefix.internal_js, 'comments.js', 'defer') %>
<% } %>

<% if (config.OhMyLive2d && config.OhMyLive2d.lazy) { %>
  <script src="<%- url_for('/live2d-config.js') %>" defer></script>
  <%- js_ex(theme.static_prefix.internal_js, 'live2d-loader.js', 'defer') %>
<% } %>

<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<%- js_ex(theme.static_prefix.internal_js, 'boot.js', 'defer') %>
