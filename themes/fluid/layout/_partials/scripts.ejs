<%- partial('_partials/plugins/nprogress.ejs') %>
<%- js_ex(theme.static_prefix.jquery, 'jquery.min.js') %>
<%- js_ex(theme.static_prefix.bootstrap, 'js/bootstrap.min.js') %>
<%- js_ex(theme.static_prefix.internal_js, 'events.js') %>
<%- js_ex(theme.static_prefix.internal_js, 'plugins.js') %>

<%- partial('_partials/plugins/typed.ejs') %>

<% if (theme.lazyload.enable){ %>
  <% if (theme.lazyload.onlypost) { %>
    <% if (is_post() || is_page()) { %>
      <%- js_ex(theme.static_prefix.internal_js, 'img-lazyload.js', 'defer') %>
    <% } %>
  <% } else { %>
    <%- js_ex(theme.static_prefix.internal_js, 'img-lazyload.js', 'defer') %>
  <% } %>
<% } %>

<% var script_snippets = deduplicate(page.script_snippets) %>
<% for (var idx = 0; idx < script_snippets.length; idx++) { %>
  <%- script_snippets[idx] %>
<% } %>
<% page.script_snippets = [] %>

<% if (theme.custom_js) { %>
  <% var customJS = Array.isArray(theme.custom_js) ? theme.custom_js : [theme.custom_js] %>
  <% for (var jsPath of customJS) { %>
    <script defer src="<%= url_for(jsPath) %>"></script>
  <% } %>
<% } %>

<% 
  var danmakuEnabled = theme.danmaku && (theme.danmaku.enabled === true || theme.danmaku.enable === true);
  var danmakuPage = (theme.danmaku && theme.danmaku.page ? theme.danmaku.page : '/comments/').replace(/^\//, '');
  var currentPath = (page.path || '').replace(/index\.html$/, '');
  var shouldLoadDanmaku = danmakuEnabled && currentPath === danmakuPage;
%>
<% if (shouldLoadDanmaku) { %>
  <!-- 注入 danmakuConfig 配置到页面中（仅弹幕页加载） -->
  <script>
    // 使用 window 挂载，确保其他脚本可访问
    window.danmakuConfig = {
      page: '<%= theme.danmaku.page %>' || '/comments/',
      line: <%- theme.danmaku.line %> || 10,
      speed: <%- theme.danmaku.speed %> || 20,
      hover: <%= theme.danmaku.hover ? true : false %>,
      loop: <%= theme.danmaku.loop ? true : false %>
    };
  </script>
  <%- js_ex(theme.static_prefix.internal_js, 'comment.js', 'defer') %>
  <%- js_ex(theme.static_prefix.internal_js, 'comments.js', 'defer') %>
<% } %>

<% if (config.OhMyLive2d && config.OhMyLive2d.lazy) { %>
  <script>
    (function () {
      var cfg = <%- JSON.stringify(config.OhMyLive2d || {}) %>;
      var degradeCfg = cfg.degrade || {};
      window.__oml2d_strategy = cfg.strategy || {};
      var userToggleKey = typeof degradeCfg.userToggleStorageKey === 'string' && degradeCfg.userToggleStorageKey.trim()
        ? degradeCfg.userToggleStorageKey.trim()
        : 'live2d:enabled';
      window.__oml2d_toggle_key = userToggleKey;
      var statusStorageKey = typeof degradeCfg.statusStorageKey === 'string' && degradeCfg.statusStorageKey.trim()
        ? degradeCfg.statusStorageKey.trim()
        : 'live2d:status';
      window.__oml2d_status_key = statusStorageKey;
      var scriptTimeoutMs = typeof degradeCfg.scriptTimeoutMs === 'number' && degradeCfg.scriptTimeoutMs > 0
        ? degradeCfg.scriptTimeoutMs
        : 8000;
      function readUserEnabled() {
        try {
          var value = window.localStorage.getItem(userToggleKey);
          if (value === null || value === undefined || value === '') return true;
          return !/^(0|false|off)$/i.test(String(value).trim());
        } catch (_) {
          return true;
        }
      }
      function writeUserEnabled(enabled) {
        try {
          window.localStorage.setItem(userToggleKey, enabled ? '1' : '0');
        } catch (_) {}
      }
      function readStoredStatus() {
        try {
          var value = window.localStorage.getItem(statusStorageKey);
          return (value === 'sleep' || value === 'active') ? value : '';
        } catch (_) {
          return '';
        }
      }
      function hasOml2dDom() {
        return !!(
          document.getElementById('oml2d-stage') ||
          document.getElementById('oml2d-statusBar') ||
          document.getElementById('oml2d-tips') ||
          document.getElementById('oml2d-menus')
        );
      }
      function removeOml2dDom() {
        var selectors = [
          '#oml2d-stage',
          '#oml2d-statusBar',
          '#oml2d-tips',
          '#oml2d-menus',
          '#oml2d-global-style',
          '#oml2d-icon-svg'
        ];
        for (var i = 0; i < selectors.length; i++) {
          var nodes = document.querySelectorAll(selectors[i]);
          for (var j = 0; j < nodes.length; j++) nodes[j].remove();
        }
      }
      function resolveParentElement(val) {
        if (!val) return document.body;
        if (typeof val === 'string') {
          if (val === 'document.body') return document.body;
          try {
            var el = document.querySelector(val);
            return el || document.body;
          } catch (_) { return document.body; }
        }
        return document.body;
      }
      function resolveHook(ref) {
        if (typeof ref === 'function') return ref;
        if (typeof ref !== 'string') return null;
        var path = ref.trim();
        if (!path) return null;
        try {
          var parts = path.split('.');
          var ctx = window;
          for (var i = 0; i < parts.length; i++) {
            if (!ctx) return null;
            ctx = ctx[parts[i]];
          }
          return typeof ctx === 'function' ? ctx : null;
        } catch (_) {
          return null;
        }
      }
      function shouldLoad() {
        if (!readUserEnabled()) {
          console && console.log && console.log('[OhMyLive2D] skip by user preference');
          return false;
        }
        var option = cfg.option || {};
        var mobileDisplay = typeof option.mobileDisplay === 'boolean' ? option.mobileDisplay : false;
        var isNarrow = window.matchMedia ? window.matchMedia('(max-width: 767px)').matches : (window.innerWidth < 768);
        if (!mobileDisplay && isNarrow) {
          console && console.log && console.log('[OhMyLive2D] skip by width: mobileDisplay=false', { width: window.innerWidth });
          return false;
        }

        var reducedMotion = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
        if (degradeCfg.disableOnReducedMotion !== false && reducedMotion) {
          console && console.log && console.log('[OhMyLive2D] skip by reduced-motion preference');
          return false;
        }

        var conn = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
        if (conn) {
          if (degradeCfg.disableOnSaveData !== false && conn.saveData) {
            console && console.log && console.log('[OhMyLive2D] skip by save-data mode');
            return false;
          }
          var effectiveType = String(conn.effectiveType || '').toLowerCase();
          if (degradeCfg.disableOnSlowNetwork !== false && /(^|-)2g$/.test(effectiveType)) {
            console && console.log && console.log('[OhMyLive2D] skip by slow network', { effectiveType: effectiveType });
            return false;
          }
        }

        var minDeviceMemory = typeof degradeCfg.minDeviceMemory === 'number' ? degradeCfg.minDeviceMemory : 2;
        if (typeof navigator.deviceMemory === 'number' && navigator.deviceMemory < minDeviceMemory) {
          console && console.log && console.log('[OhMyLive2D] skip by low memory', { deviceMemory: navigator.deviceMemory });
          return false;
        }

        var minHardwareConcurrency = typeof degradeCfg.minHardwareConcurrency === 'number' ? degradeCfg.minHardwareConcurrency : 2;
        if (typeof navigator.hardwareConcurrency === 'number' && navigator.hardwareConcurrency < minHardwareConcurrency) {
          console && console.log && console.log('[OhMyLive2D] skip by low cpu cores', { hardwareConcurrency: navigator.hardwareConcurrency });
          return false;
        }

        return true;
      }
      function scheduleLoad(callback) {
        if ('requestIdleCallback' in window) {
          window.requestIdleCallback(function () { callback(); }, { timeout: 2500 });
        } else {
          window.setTimeout(callback, 200);
        }
      }
      function loadOML() {
        if (!shouldLoad()) return;
        if (window.__oml2d_loading || window.__oml2d_loaded) { return; }
        if (hasOml2dDom()) {
          if (window.__oml2d_instance) {
            window.__oml2d_loaded = true;
            return;
          }
          // 清理残留节点，避免历史实例导致“只关掉最新实例”
          removeOml2dDom();
        }
        window.__oml2d_loading = true;
        console && console.log && console.log('[OhMyLive2D] start loading');
        var primary = cfg.CDN || 'https://registry.npmmirror.com/oh-my-live2d/0.19.3/files/index.min.js';
        var fallback = 'https://cdn.jsdelivr.net/npm/oh-my-live2d@0.19.3/dist/index.min.js';
        function onScriptLoaded() {
          window.__oml2d_sdk_loaded = true;
          // oh-my-live2d exposes either `OML2D.loadOml2d` (modern) or `OhMyLive2D.load` (legacy/packaged)
          var api = null;
          var apiType = '';
          if (window.OML2D && typeof window.OML2D.loadOml2d === 'function') { api = window.OML2D.loadOml2d; apiType = 'OML2D'; }
          else if (window.OhMyLive2D && typeof window.OhMyLive2D.load === 'function') { api = window.OhMyLive2D.load; apiType = 'OhMyLive2D'; }
          if (!api) {
            console && console.warn && console.warn('[OhMyLive2D] global API not found');
            window.__oml2d_loading = false;
            return;
          }
          var opt = cfg.option || {};
          // merge helper for tips styles
          function mergeTips(base, extra) {
            var out = {};
            base = base || {};
            for (var k in base) if (Object.prototype.hasOwnProperty.call(base, k)) out[k] = base[k];
            for (var k2 in extra) if (Object.prototype.hasOwnProperty.call(extra, k2)) out[k2] = extra[k2];
            return out;
          }

          var options = {
            mobileDisplay: !!opt.mobileDisplay,
            models: Array.isArray(opt.models) ? opt.models : [],
            parentElement: resolveParentElement(opt.parentElement),
            primaryColor: opt.primaryColor,
            sayHello: !!opt.sayHello,
            initialStatus: (function() {
              var storedStatus = readStoredStatus();
              if (storedStatus) return storedStatus;
              return (opt.initialStatus === 'sleep' || opt.initialStatus === 'active') ? opt.initialStatus : 'active';
            })(),
            // place stage on the right by default
            dockedPosition: 'right',
            libraryUrls: opt.libraryUrls || undefined,
            // Ensure stage is visible even if defaults keep it translated or size 0
            stageStyle: Object.assign({
              position: 'fixed',
              right: '32px',
              bottom: '0px',
              width: '280px',
              height: '280px',
              zIndex: '2147483646',
              left: 'auto'
            }, opt.stageStyle || {}),
            // Fix tips (speech bubble) position: anchor to stage right-top area
            tips: (function(){
              var t = opt.tips || {};
              // place bubble centered above stage
              var style = mergeTips(t.style, {
                right: 'auto',
                left: '50%',
                top: 'auto',
                bottom: 'calc(100% + 8px)',
                transform: 'translateX(-50%)',
                width: (t.style && t.style.width) || '240px'
              });
              var mstyle = mergeTips(t.mobileStyle, {
                right: 'auto',
                left: '50%',
                top: 'auto',
                bottom: 'calc(100% + 8px)',
                transform: 'translateX(-50%)',
                width: (t.mobileStyle && t.mobileStyle.width) || '180px'
              });
              return Object.assign({}, t, { style: style, mobileStyle: mstyle });
            })(),
            // Move vertical menus a bit further left
            menus: (function(){
              var m = opt.menus || {};
              var style = mergeTips(m.style, {
                left: (m.style && m.style.left) || '-28px'
              });
              var mstyle = mergeTips(m.mobileStyle, {
                left: (m.mobileStyle && m.mobileStyle.left) || '-24px'
              });
              return Object.assign({}, m, { style: style, mobileStyle: mstyle });
            })()
          };
          try {
            if (hasOml2dDom()) {
              window.__oml2d_loaded = true;
              window.__oml2d_loading = false;
              console && console.log && console.log('[OhMyLive2D] stage exists, skip init');
              return;
            }
            var oml2d = api(options);
            window.__oml2d_instance = oml2d;
            // Let library control stage animation; avoid forcing double slide-in
            // 安全地解析回调函数名，避免使用 eval
            (function(){
              var hookRef = <%- JSON.stringify((config.OhMyLive2d && config.OhMyLive2d.then) || '') %>;
              try {
                var fn = resolveHook(hookRef);
                if (fn) { fn(oml2d); }
                else if (hookRef) { console && console.warn && console.warn('[OhMyLive2D] hook not found:', hookRef); }
              } catch(_) { /* ignore hook error */ }
            })();
            window.__oml2d_loaded = true;
            window.__oml2d_loading = false;
            console && console.log && console.log('[OhMyLive2D] loaded via', apiType);
          } catch (e) {
            window.__oml2d_loading = false;
            console && console.error && console.error('[OhMyLive2D] load error', e);
          }
        }
        var sdkInitDone = false;
        function runSdkInitOnce() {
          if (sdkInitDone) return;
          sdkInitDone = true;
          onScriptLoaded();
        }
        function loadScriptWithTimeout(src, label, onSuccess, onFail) {
          var script = document.createElement('script');
          script.src = src;
          script.defer = true;
          var done = false;
          function finish(success, reason) {
            if (done) return;
            done = true;
            script.onload = null;
            script.onerror = null;
            if (timer) window.clearTimeout(timer);
            if (!success) {
              try { script.remove(); } catch (_) {}
              if (typeof onFail === 'function') onFail(reason || 'error');
              return;
            }
            if (typeof onSuccess === 'function') onSuccess();
          }
          var timer = window.setTimeout(function () {
            finish(false, 'timeout');
          }, scriptTimeoutMs);
          script.onload = function () { finish(true); };
          script.onerror = function () { finish(false, 'error'); };
          document.head.appendChild(script);
        }
        loadScriptWithTimeout(primary, 'primary', runSdkInitOnce, function (reason) {
          console && console.warn && console.warn('[OhMyLive2D] primary CDN failed, retry fallback', { reason: reason, timeout: scriptTimeoutMs });
          loadScriptWithTimeout(fallback, 'fallback', runSdkInitOnce, function (fallbackReason) {
            window.__oml2d_loading = false;
            console && console.error && console.error('[OhMyLive2D] fallback CDN failed', { reason: fallbackReason, timeout: scriptTimeoutMs });
          });
        });
      }
      function unloadOML() {
        var instance = window.__oml2d_instance;
        try {
          if (instance && typeof instance.clearTips === 'function') instance.clearTips();
        } catch (_) {}
        try {
          if (instance && typeof instance.stopTipsIdle === 'function') instance.stopTipsIdle();
        } catch (_) {}
        try {
          if (instance && typeof instance.stageSlideOut === 'function') instance.stageSlideOut();
        } catch (_) {}
        removeOml2dDom();
        window.setTimeout(removeOml2dDom, 350);
        window.__oml2d_instance = null;
        window.__oml2d_loaded = false;
        window.__oml2d_loading = false;
      }
      function start() {
        var started = false;
        function runOnce() {
          if (started) return;
          started = true;
          try { loadOML(); } catch (_) {}
        }
        function runWithFallback() {
          scheduleLoad(runOnce);
          window.setTimeout(runOnce, 3500);
        }
        if (document.visibilityState === 'hidden') {
          var onVisible = function () {
            if (document.visibilityState !== 'visible') return;
            document.removeEventListener('visibilitychange', onVisible);
            runWithFallback();
          };
          document.addEventListener('visibilitychange', onVisible);
          window.setTimeout(runWithFallback, 12000);
          return;
        }
        runWithFallback();
      }
      window.__loadOhMyLive2D = function () {
        writeUserEnabled(true);
        start();
      };
      window.__unloadOhMyLive2D = function () {
        writeUserEnabled(false);
        unloadOML();
      };
      window.__setOhMyLive2DEnabled = function (enabled) {
        if (enabled) window.__loadOhMyLive2D();
        else window.__unloadOhMyLive2D();
      };
      if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', start, { once: true });
      else start();
    })();
  </script>
<% } %>

<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<%- js_ex(theme.static_prefix.internal_js, 'boot.js', 'defer') %>
