<%
var separator = theme.title_join_string || theme.tab_title_separator
var title = page.title ? [page.title, config.title].join(separator) : config.title
var keywords = page.keywords || config.keywords
if (keywords instanceof Array) {
  keywords = keywords.join(',')
}
var description = page.description || page.excerpt || (is_post() && page.content) || config.description
if (description) {
  description = strip_html(description).substring(0, 200).trim().replace(/\n/g, ' ')
}
var ogImage = page.og_img || page.index_img
var ogImageUrl = ogImage ? (String(ogImage).match(/^https?:\/\//) ? ogImage : url_join(config.url, url_for(ogImage))) : null
var ogConfig = Object.assign({ image: ogImage && url_for(ogImage) }, theme.open_graph)
var canonicalPath = (page.canonical_path || page.path || '').replace('index.html', '')
var canonicalUrl = url_join(config.url, canonicalPath)
var homeUrl = url_join(config.url, '/')
var heroImage = page.banner_img || theme.index.banner_img
var selectedCommentType = typeof page.comment === 'string' && page.comment !== '' ? page.comment : theme.post.comments.type
var layoutName = page.layout || ''
var commentsEnabledOnCurrentPage = false
if (layoutName === 'post') {
  commentsEnabledOnCurrentPage = theme.post.comments.enable && page.comments
} else if (layoutName === 'links') {
  commentsEnabledOnCurrentPage = theme.links.comments && theme.links.comments.enable
} else if (layoutName === 'page' || layoutName === 'about' || layoutName === 'comments') {
  commentsEnabledOnCurrentPage = page.comments
}
var walinePreconnectEnabled = theme.waline
  && theme.waline.serverURL
  && selectedCommentType === 'waline'
  && commentsEnabledOnCurrentPage
var breadcrumbItemList = [{
  "@type": "ListItem",
  "position": 1,
  "name": config.title,
  "item": homeUrl
}]
if (!is_home()) {
  var breadcrumbName = page.title
  if (!breadcrumbName) {
    if (is_category()) {
      breadcrumbName = page.category ? `分类：${page.category}` : '分类'
    } else if (is_tag()) {
      breadcrumbName = page.tag ? `标签：${page.tag}` : '标签'
    } else if (is_archive()) {
      breadcrumbName = '归档'
    } else {
      breadcrumbName = title
    }
  }
  breadcrumbItemList.push({
    "@type": "ListItem",
    "position": 2,
    "name": breadcrumbName,
    "item": canonicalUrl
  })
}
%>

<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="<%= url_for(theme.apple_touch_icon) %>">
  <link rel="icon" href="<%= url_for(theme.favicon) %>">
  <% if (theme.canonical.enable) { %>
    <link rel="canonical" href="<%= canonicalUrl %>"/>
  <% } %>
  <% if ((is_home() || is_post() || is_page()) && heroImage) { %>
    <link rel="preload" as="image" href="<%= url_for(heroImage) %>" fetchpriority="high">
  <% } %>

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <% if (theme.force_https) { %>
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  <% } %>
  <meta name="theme-color" content="<%= theme.color.navbar_bg_color %>">
  <meta name="author" content="<%= page.author || config.author %>">
  <meta name="keywords" content="<%= keywords %>">
  <!-- Performance: preconnect/dns-prefetch for common CDNs -->
  <link rel="preconnect" href="https://lib.baomitu.com" crossorigin>
  <link rel="dns-prefetch" href="//lib.baomitu.com">
  <link rel="preconnect" href="https://qiuniu.phlin.cn" crossorigin>
  <link rel="dns-prefetch" href="//qiuniu.phlin.cn">
  <link rel="preconnect" href="https://at.alicdn.com" crossorigin>
  <link rel="dns-prefetch" href="//at.alicdn.com">
  <% if (theme.web_analytics && theme.web_analytics.umami && theme.web_analytics.umami.api_server) { %>
    <link rel="preconnect" href="<%= theme.web_analytics.umami.api_server %>" crossorigin>
    <link rel="dns-prefetch" href="//<%= theme.web_analytics.umami.api_server.replace(/^https?:\/\//,'') %>">
  <% } %>
  <% if (walinePreconnectEnabled) { %>
    <link rel="preconnect" href="<%= theme.waline.serverURL %>" crossorigin>
    <link rel="dns-prefetch" href="//<%= theme.waline.serverURL.replace(/^https?:\/\//,'').replace(/\/$/,'') %>">
  <% } %>
  <% if (theme.open_graph.enable) { %>
    <%- open_graph(ogConfig) %>
  <% } else { %>
    <meta name="description" content="<%= description %>">
  <% } %>
  <script type="application/ld+json">
    <%- JSON.stringify({
      "@context": "https://schema.org",
      "@type": "WebSite",
      "name": config.title,
      "url": config.url,
      "inLanguage": config.language
    }) %>
  </script>
  <% if (breadcrumbItemList.length > 1) { %>
  <script type="application/ld+json">
    <%- JSON.stringify({
      "@context": "https://schema.org",
      "@type": "BreadcrumbList",
      "itemListElement": breadcrumbItemList
    }) %>
  </script>
  <% } %>
  <% if (is_post()) { %>
  <script type="application/ld+json">
    <%- JSON.stringify({
      "@context": "https://schema.org",
      "@type": "Article",
      "headline": page.title,
      "description": description,
      "author": { "@type": "Person", "name": page.author || config.author },
      "datePublished": page.date ? date_xml(page.date) : undefined,
      "dateModified": (page.updated || page.date) ? date_xml(page.updated || page.date) : undefined,
      "url": canonicalUrl,
      "mainEntityOfPage": canonicalUrl,
      "image": ogImageUrl || undefined,
      "inLanguage": config.language
    }) %>
  </script>
  <% } %>
  <% if ((theme.post.meta.views.enable && theme.post.meta.views.source === 'busuanzi')
    || (theme.footer.statistics.enable && theme.footer.statistics.source === 'busuanzi')) { %>
    <meta name="referrer" content="no-referrer-when-downgrade">
  <% } %>
  <% if (theme.custom_head) { %>
    <%- theme.custom_head %>
  <% } %>
  <title><%= title %></title>

  <%- partial('_partials/css.ejs') %>
  <%- export_config() %>
  <%- js_ex(theme.static_prefix.internal_js, 'utils.js') %>
  <%- js_ex(theme.static_prefix.internal_js, 'color-schema.js') %>
  <%- partial('_partials/plugins/analytics.ejs') %>

  <%- inject_point('head') %>
</head>
