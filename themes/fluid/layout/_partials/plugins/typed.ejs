<% if(theme.fun_features.typing.enable && in_scope(theme.fun_features.typing.scope) && page.subtitle !== false) { %>
  <%- js_ex(theme.static_prefix.typed, '/typed.min.js', 'defer') %>
  <script>
    (function (window, document) {
      function initTyping() {
        var typing = Fluid.plugins.typing;
        var subtitle = document.getElementById('subtitle');
        if (!subtitle || !typing || !window.Typed) {
          return;
        }
        var text = subtitle.getAttribute('data-typed-text');
        <% if (is_home() && theme.index.slogan.api && theme.index.slogan.api.enable) { %>
          fetch('<%- theme.index.slogan.api.url %>', {
            method: '<%= theme.index.slogan.api.method %>',
            headers: <%- JSON.stringify(theme.index.slogan.api.headers || {}) %>
          })
            .then(function(response) {
              if (!response.ok) {
                throw new Error('HTTP ' + response.status);
              }
              return response.json();
            })
            .then(function(result) {
              var apiText;
              if (result) {
                var keys = '<%= theme.index.slogan.api.keys %>'.split(',');
                if (result instanceof Array) {
                  result = result[0];
                }
                for (const k of keys) {
                  var value = result[k];
                  if (typeof value === 'string') {
                    apiText = value;
                    break;
                  } else if (value instanceof Object) {
                    result = value;
                  }
                }
              }
              apiText ? typing(apiText) : typing(text);
            })
            .catch(function(error) {
              if (error) {
                console.error('Failed to request <%= theme.index.slogan.api.url %>:', error);
              }
              typing(text);
            });
        <% } else { %>
          typing(text);
        <% } %>
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initTyping, { once: true });
      } else {
        initTyping();
      }
    })(window, document);
  </script>
<% } %>
