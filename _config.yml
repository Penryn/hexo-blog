# Hexo Configuration
## Docs: https://hexo.io/docs/configuration.html
## Source: https://github.com/hexojs/hexo/

# Site
title: "phlin's blog"
subtitle: "望舒的尘歌壶"
description: "一个后端开发的个人学习笔记"
keywords:
  - 后端开发
  - Golang
  - 面试复盘
  - 学习笔记
author: phlin
language: zh-CN
timezone: Asia/Shanghai


# URL
## Set your site url here. For example, if you use GitHub Page, set url as 'https://username.github.io/project'
url: https://blog.phlin.cn
permalink: :year/:month/:day/:title/
permalink_defaults:
pretty_urls:
  trailing_index: false # Set to false to remove trailing 'index.html' from permalinks
  trailing_html: false # Set to false to remove trailing '.html' from permalinks

# Directory
source_dir: source
public_dir: public
tag_dir: tags
archive_dir: archives
category_dir: categories
code_dir: downloads/code
i18n_dir: :lang
skip_render:
  - live2d/**
  - xml/**
  - googlee71a42e975b91904.html

# Writing
new_post_name: :title.md # File name of new posts
default_layout: post
titlecase: false # Transform title into titlecase
external_link:
  enable: true # Open external links in new tab
  field: site # Apply to the whole site
  exclude: ''
filename_case: 0
render_drafts: false
post_asset_folder: false
relative_link: false
future: false
syntax_highlighter: highlight.js
highlight:
  line_number: true
  auto_detect: false
  tab_replace: ''
  wrap: true
  hljs: false
prismjs:
  preprocess: true
  line_number: true
  tab_replace: ''

# Home page setting
# path: Root path for your blogs index page. (default = '')
# per_page: Posts displayed per page. (0 = disable pagination)
# order_by: Posts order. (Order by date descending by default)
index_generator:
  path: ''
  per_page: 10
  order_by: -date

# Category & Tag
default_category: uncategorized
category_map:
tag_map:

# Metadata elements
## https://developer.mozilla.org/en-US/docs/Web/HTML/Element/meta
meta_generator: true

# Date / Time format
## Hexo uses Moment.js to parse and display date
## You can customize the date format as defined in
## http://momentjs.com/docs/#/displaying/format/
date_format: YYYY-MM-DD
time_format: HH:mm:ss
## updated_option supports 'mtime', 'date', 'empty'
updated_option: 'mtime'

# Pagination
## Set per_page to 0 to disable pagination
per_page: 10
pagination_dir: page

# Include / Exclude file(s)
## include:/exclude: options only apply to the 'source/' folder
include: []
exclude:
  - live2d/**
ignore:
  - "**/source/live2d/**"

# Extensions
## Plugins: https://hexo.io/plugins/
## Themes: https://hexo.io/themes/
theme: fluid

# Deployment
## Docs: https://hexo.io/docs/one-command-deployment
deploy:
  type: ''


feed:
  type: rss2
  path: rss2.xml
  limit: 
  hub:
  content:
  content_limit: 
  content_limit_delim: ' '
  order_by: -date

sitemap:
  path: sitemap.xml
  tags: false
  categories: false

robots:
  user_agent: "*"
  allow:
    - /
  disallow:
    - /live2d/
  sitemaps:
    - https://blog.phlin.cn/sitemap.xml

minify:
  js:
    enable: true
    exclude:
      - "*.min.js"
      - "live2d/**"
  css:
    enable: true
    options:
      targets: ">= 0.5%, not dead"
    exclude:
      - "*.min.css"
  image:
    enable: true
    options:
      avif: false
      webp: true
      quality: 70
      effort: 2
      replaceSrc: true
      destroyOldRoute: false
      enableSubSampling: true
      persistCache: true
    exclude:
      - "live2d/**"
      - "img/favicon-32.png"
      - "img/apple-touch-icon.png"

# _config.yml
OhMyLive2d:
  enable: false # disable plugin injection; we lazy-load via theme
  lazy: true
  # CDN: https://registry.npmmirror.com/oh-my-live2d@0.19.3/dist/index.min.js
  CDN: https://cdn.jsdelivr.net/npm/oh-my-live2d@0.19.3/dist/index.min.js
  degrade:
    disableOnReducedMotion: true
    disableOnSaveData: true
    disableOnSlowNetwork: true
    minDeviceMemory: 2
    minHardwareConcurrency: 2
    userToggleStorageKey: live2d:enabled
    statusStorageKey: live2d:status
    scriptTimeoutMs: 3500
    # 首屏后延迟加载（2.5s）：兼顾关键渲染与刷新后可感知速度
    startAfterLoadMs: 2500
  strategy:
    enable: true
    # 页面类型优先切模（可填模型索引或模型 name），未命中时按时间兜底
    pageTypeModelMap:
      home: 0
      post: 0
      about: 0
      links: 0
      comments: 0
      archive: 1
      category: 1
      tag: 1
    useTimeFallback: true
    modelRotateIntervalMs: 1800000 # 30 分钟
    clothesRotateIntervalMs: 600000 # 10 分钟（仅 path 为数组时生效）
  option:
    importType: 'cubism5' # 导入类型, 默认使用全量导入: complete , 可选值: complete, cubism2, cubism5
    libraryUrls: # 自定义 Cubism SDK 外部资源地址
      complete: https://registry.npmmirror.com/oh-my-live2d/0.19.3/files/lib/complete.js
      cubism2: https://registry.npmmirror.com/oh-my-live2d/0.19.3/files/lib/cubism2.js
      cubism5: https://registry.npmmirror.com/oh-my-live2d/0.19.3/files/lib/cubism5.js

    mobileDisplay: false # 是否在移动端显示
    models:
      - path: https://qiuniu.phlin.cn/blog/Focalors.model3.json
        mobilePosition: [-10, 23] # 移动端时模型在舞台中的位置。 默认值: [0,0] [横坐标, 纵坐标]
        mobileScale: 0.1 # 移动端时模型的缩放比例 默认值: 0.1
        mobileStageStyle: # 移动端时舞台的样式
          width: 180
          height: 166
        motionPreloadStrategy: IDLE # 动作预加载策略 默认值: IDLE 可选值: ALL | IDLE | NONE
        position: [-160, -30] # 模型在舞台中的位置。 默认值: [0,0] [横坐标, 纵坐标]
        scale: 0.1 # 模型的缩放比例 默认值: 0.1
        stageStyle:
          width: 250
          height: 250

    parentElement: document.body # 为组件提供一个父元素，如果未指定则默认挂载到 body 中
    primaryColor: 'var(--btn-bg)' # 主题色 支持变量
    sayHello: false # 是否在初始化阶段打印项目信息

    tips:
      messageLine: 7
      style:
        width: "280px"
        minHeight: "100px"
        padding: "15px 20px"
        left: auto
        right: calc(100% + 20px)
        top: -60px
        textAlign: "left"
        color: "#333333"
        backgroundColor: "rgba(255, 255, 255, 0.95)"
        backdropFilter: "blur(5px)"
        borderRadius: "15px"
        border: "1px solid rgba(255, 255, 255, 0.4)"
        boxShadow: "0 8px 32px 0 rgba(31, 38, 135, 0.1)"
        fontSize: "14px"
        textShadow: "none"
        lineHeight: 1.5
        fontFamily: "'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif"
      mobileStyle:
        width: "220px"
        minHeight: "80px"
        padding: "10px 15px"
        left: auto
        right: calc(100% + 10px)
        top: -60px
        textAlign: "left"
        color: "#333333"
        backgroundColor: "rgba(255, 255, 255, 0.95)"
        backdropFilter: "blur(4px)"
        borderRadius: "12px"
        border: "1px solid rgba(255, 255, 255, 0.4)"
        boxShadow: "0 6px 24px 0 rgba(31, 38, 135, 0.08)"
        fontSize: "13px"
        textShadow: "none"
        lineHeight: 1.4
      idleTips:
        interval: 60000
        # message:
        #   - 你好呀~
        #   - 欢迎来到我的小站~
        # 自定义提示语（多分类随机 + 超时重试 + 并发锁 + SWR 缓存池）
        message: |
          function(){
            var root = (typeof window !== 'undefined')
              ? window
              : ((typeof globalThis !== 'undefined') ? globalThis : {});
            var cacheKey = 'live2d:hitokoto:cache:v6';
            var lockKey = 'live2d:hitokoto:lock:v1';
            var inflightKey = '__live2d_hitokoto_inflight_v1';
            var cacheTtlMs = 10 * 60 * 1000;
            var staleTtlMs = 24 * 60 * 60 * 1000;
            var lockTtlMs = 15 * 1000;
            var waitForLockMs = 1800;
            var requestTimeoutMs = 3500;
            var backoffKey = 'live2d:hitokoto:backoff:v1';
            var backoffBaseMs = 30 * 1000;
            var backoffMaxMs = 30 * 60 * 1000;
            var backoffMaxFailCount = 8;
            var targetPoolSize = 4;
            var fallbackPool = [
              '今天也要稳扎稳打，慢一点也没关系。',
              '别急，先把手上的一个点做到可验证。',
              '复杂问题先拆小，持续迭代就会有进展。',
              '写代码前先想边界条件，能省很多返工。'
            ];
            var categories = ['a', 'b', 'c', 'd', 'e', 'f', 'h', 'i', 'k', 'l'];
            function now() {
              return Date.now();
            }
            function randomPick(arr, count) {
              var copied = arr.slice();
              var out = [];
              var take = Math.max(1, Math.min(count, copied.length));
              for (var i = 0; i < take; i++) {
                var idx = Math.floor(Math.random() * copied.length);
                out.push(copied.splice(idx, 1)[0]);
              }
              return out;
            }
            function randomFallback() {
              return fallbackPool[Math.floor(Math.random() * fallbackPool.length)];
            }
            function normalizeText(value) {
              return (typeof value === 'string') ? value.trim() : '';
            }
            function normalizeComparableText(value) {
              return normalizeText(value)
                .toLowerCase()
                .replace(/[\s\-_.·•,，。!！?？'"“”‘’`~:：;；()（）\[\]{}<>《》【】]/g, '');
            }
            function sameTextIgnoreCase(a, b) {
              if (!a || !b) return false;
              return normalizeComparableText(a) === normalizeComparableText(b);
            }
            function limitText(value, maxLen) {
              if (!value || value.length <= maxLen) return value;
              return value.slice(0, maxLen - 1) + '…';
            }
            function escapeHtml(value) {
              return String(value)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
            }
            // 兼容历史缓存格式：去掉末尾的 “ · 类型”
            function stripLegacyTypeSuffix(value) {
              var text = normalizeText(value);
              if (!text) return '';
              text = text.replace(/(<br>——[^<]+?)\s·\s[^<·]+$/, '$1');
              text = text.replace(/\s·\s[^<·]+$/, '');
              return text;
            }
            function formatQuote(data) {
              var quote = normalizeText(data && data.hitokoto) || randomFallback();
              quote = limitText(quote, 88);
              var from = limitText(normalizeText(data && data.from), 20);
              var fromWho = limitText(normalizeText(data && data.from_who), 14);
              if (sameTextIgnoreCase(from, fromWho)) fromWho = '';
              var source = '';
              if (from) {
                source = '《' + from + '》';
                if (fromWho) source += '（' + fromWho + '）';
              } else if (fromWho) {
                source = fromWho;
              }
              var safeQuote = escapeHtml(quote);
              return source
                ? (safeQuote + '<br>—— ' + escapeHtml(source))
                : safeQuote;
            }
            function fetchJsonWithTimeout(url, timeoutMs) {
              if (typeof AbortController === 'function') {
                var controller = new AbortController();
                var timer = setTimeout(function () { controller.abort(); }, timeoutMs);
                return fetch(url, { signal: controller.signal })
                  .then(function (response) {
                    clearTimeout(timer);
                    return response;
                  })
                  .catch(function (error) {
                    clearTimeout(timer);
                    throw error;
                  });
              }
              var timerId = 0;
              var timeoutPromise = new Promise(function (_, reject) {
                timerId = setTimeout(function () {
                  reject(new Error('hitokoto request timeout'));
                }, timeoutMs);
              });
              return Promise.race([fetch(url), timeoutPromise]).then(function (response) {
                clearTimeout(timerId);
                return response;
              }, function (error) {
                clearTimeout(timerId);
                throw error;
              });
            }
            function fetchOne() {
              var selected = randomPick(categories, 2 + Math.floor(Math.random() * 2));
              var params = new URLSearchParams();
              for (var i = 0; i < selected.length; i++) {
                params.append('c', selected[i]);
              }
              params.set('min_length', '8');
              params.set('max_length', '80');
              return fetchJsonWithTimeout('https://v1.hitokoto.cn?' + params.toString(), requestTimeoutMs)
              .then(function (response) {
                if (!response.ok) {
                  throw new Error('hitokoto request failed: ' + response.status);
                }
                return response.json();
              })
              .then(function (data) {
                return formatQuote(data);
              });
            }
            function readCache() {
              try {
                var raw = localStorage.getItem(cacheKey);
                if (!raw) return null;
                var cache = JSON.parse(raw);
                if (!cache || !Array.isArray(cache.pool) || !cache.pool.length) return null;
                if (!cache.ts || (now() - cache.ts) >= staleTtlMs) return null;
                var pool = [];
                for (var i = 0; i < cache.pool.length; i++) {
                  var text = stripLegacyTypeSuffix(cache.pool[i]);
                  if (!text) continue;
                  if (pool.indexOf(text) !== -1) continue;
                  pool.push(text);
                }
                if (!pool.length) return null;
                cache.pool = pool;
                if (typeof cache.idx !== 'number' || !isFinite(cache.idx)) cache.idx = 0;
                return cache;
              } catch (_) {
                return null;
              }
            }
            function writeCache(cache) {
              try {
                localStorage.setItem(cacheKey, JSON.stringify(cache));
              } catch (_) {}
            }
            function readBackoff() {
              try {
                var raw = localStorage.getItem(backoffKey);
                if (!raw) return { failCount: 0, nextRetryAt: 0 };
                var state = JSON.parse(raw);
                if (!state || typeof state !== 'object') return { failCount: 0, nextRetryAt: 0 };
                var failCount = Number(state.failCount);
                if (!isFinite(failCount) || failCount < 0) failCount = 0;
                var nextRetryAt = Number(state.nextRetryAt);
                if (!isFinite(nextRetryAt) || nextRetryAt < 0) nextRetryAt = 0;
                return { failCount: Math.floor(failCount), nextRetryAt: Math.floor(nextRetryAt) };
              } catch (_) {
                return { failCount: 0, nextRetryAt: 0 };
              }
            }
            function writeBackoff(state) {
              try {
                localStorage.setItem(backoffKey, JSON.stringify(state));
              } catch (_) {}
            }
            function getBackoffState() {
              return readBackoff();
            }
            function inBackoffWindow(state) {
              return !!(state && state.nextRetryAt > now());
            }
            function markRefreshSuccess() {
              writeBackoff({ failCount: 0, nextRetryAt: 0 });
            }
            function markRefreshFailure() {
              var state = readBackoff();
              var failCount = state.failCount + 1;
              if (failCount > backoffMaxFailCount) failCount = backoffMaxFailCount;
              var delay = backoffBaseMs * Math.pow(2, failCount - 1);
              if (!isFinite(delay) || delay < backoffBaseMs) delay = backoffBaseMs;
              if (delay > backoffMaxMs) delay = backoffMaxMs;
              writeBackoff({
                failCount: failCount,
                nextRetryAt: now() + delay
              });
            }
            function nextFromCache(cache) {
              if (!cache || !Array.isArray(cache.pool) || !cache.pool.length) return '';
              var idx = cache.idx % cache.pool.length;
              if (idx < 0) idx = 0;
              var text = cache.pool[idx] || '';
              cache.idx = (idx + 1) % cache.pool.length;
              writeCache(cache);
              return text;
            }
            function readLock() {
              try {
                var raw = localStorage.getItem(lockKey);
                if (!raw) return null;
                var lock = JSON.parse(raw);
                if (!lock || typeof lock.id !== 'string' || typeof lock.expireAt !== 'number') return null;
                return lock;
              } catch (_) {
                return null;
              }
            }
            function createLockId() {
              return String(now()) + ':' + Math.random().toString(36).slice(2);
            }
            function tryAcquireLock(lockId) {
              try {
                var current = readLock();
                if (current && current.expireAt > now() && current.id !== lockId) return false;
                localStorage.setItem(lockKey, JSON.stringify({ id: lockId, expireAt: now() + lockTtlMs }));
                var verify = readLock();
                return !!(verify && verify.id === lockId);
              } catch (_) {
                return false;
              }
            }
            function releaseLock(lockId) {
              try {
                var current = readLock();
                if (current && current.id === lockId) {
                  localStorage.removeItem(lockKey);
                }
              } catch (_) {}
            }
            function waitForCache(timeoutMs) {
              return new Promise(function (resolve) {
                var end = now() + timeoutMs;
                (function poll() {
                  var cache = readCache();
                  if (cache) return resolve(cache);
                  if (now() >= end) return resolve(null);
                  setTimeout(poll, 120);
                })();
              });
            }
            function buildPoolWithLock(lockId) {
              var tasks = [];
              for (var n = 0; n < targetPoolSize; n++) {
                tasks.push(fetchOne().catch(function () { return ''; }));
              }
              return Promise.all(tasks).then(function (response) {
                var pool = [];
                for (var i = 0; i < response.length; i++) {
                  var text = response[i];
                  if (!text || pool.indexOf(text) !== -1) continue;
                  pool.push(text);
                }
                if (!pool.length) return null;
                var cache = { pool: pool, idx: 0, ts: now() };
                writeCache(cache);
                return cache;
              }).finally(function () {
                releaseLock(lockId);
              });
            }
            function refreshPool() {
              var backoff = getBackoffState();
              if (inBackoffWindow(backoff)) {
                return Promise.resolve(readCache());
              }
              if (root[inflightKey]) return root[inflightKey];
              var lockId = createLockId();
              if (!tryAcquireLock(lockId)) {
                return waitForCache(waitForLockMs).then(function (cache) {
                  return cache || readCache();
                });
              }
              var task = buildPoolWithLock(lockId)
                .then(function (cache) {
                  if (cache && cache.pool && cache.pool.length) {
                    markRefreshSuccess();
                    return cache;
                  }
                  markRefreshFailure();
                  return null;
                })
                .catch(function (error) {
                  console.error('[OhMyLive2D] idleTips refresh failed', error);
                  markRefreshFailure();
                  return null;
                });
              var wrapped = task.finally(function () {
                if (root[inflightKey] === wrapped) root[inflightKey] = null;
              });
              root[inflightKey] = wrapped;
              return wrapped;
            }
            function refreshInBackground() {
              refreshPool().catch(function () {});
            }
            var cached = readCache();
            if (cached) {
              var text = nextFromCache(cached) || randomFallback();
              var backoff = getBackoffState();
              if ((now() - cached.ts) >= cacheTtlMs && !inBackoffWindow(backoff)) {
                refreshInBackground();
              }
              return Promise.resolve(text);
            }
            return refreshPool()
              .then(function (cache) {
                var latest = cache || readCache();
                if (!latest) return randomFallback();
                return nextFromCache(latest) || randomFallback();
              })
              .catch(function (error) {
                console.error('[OhMyLive2D] idleTips request failed', error);
                return randomFallback();
              });
          }
        # true/function 会接管 message，若希望走上面的自定义 message，请保持 false
        wordTheDay: false
    statusBar:
      style:
        color: "#0f172a"
        backgroundColor: "rgba(255, 255, 255, 0.92)"
        border: "1px solid rgba(15, 23, 42, 0.14)"
        boxShadow: "0 10px 28px rgba(15, 23, 42, 0.18)"
      mobileStyle:
        color: "#0f172a"
        backgroundColor: "rgba(255, 255, 255, 0.92)"
        border: "1px solid rgba(15, 23, 42, 0.14)"
        boxShadow: "0 8px 20px rgba(15, 23, 42, 0.16)"

then: live2dHooks.onReady
